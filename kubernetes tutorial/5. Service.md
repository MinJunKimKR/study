# 서비스
서비스는 여러개의 파드에 접근할 수 있는 IP 하나를 제공한다. 다양한 기능을 제공하지만 본질적으로는 로드밸런서 역할을 한다. 

## 서비스의 개념
쿠버네티스 클러스터 안에 컨트롤러를 이용해서 파드를 실행했다면, 파드에는 접근하는 방법을 알아야 한다.  
  
파드는 컨트롤러가 관리하므로, 한군데에 고정되어 실행되는 것이 아니라, 클러스터 안을 옮겨다닌다. 이 과정에서 노드를 옮기기도 하고, 클러스터 안
파드의 IP가 변경되기도 한다. 이렇게 동적으로 변하는 파드들에 고정적으로 접근할 때 사용하는 방법이 쿠버네티스의 "서비스"이다.  

서비스를 사용하면 고정주소를 이용해 파드에 접근할 수 있다. 또한, 클러스터 외부에서 클러스터 안 파드에 접근할 수도있다. 인그레스를 통해서도 외부에서 내부로 접속 할 수 있지만 보통 서비스는 주로 L4 영역에서 통신할 때 사용하고, 인그레스는 L7영역에서 통신할 때 사용한다.  

## 서비스 타입
서비스 타입에는 크게 네가지가 있다.

* **ClusterIP** : 기본 서비스 타입이며, 쿠버네티스 클러스터 안에서만 사용할 수 있다. 클러스터 안 노드나 파드에서는 클러스터 IP를 이용해서 서비스에 연결된 파드에 접근한다. 클러스터 외부에서는 사용할 수 없다.  

* **NodePort** : 서비스 하나에 모든 노드의 지정된 포트를 할당한다. node1:8080, node2:8080처럼 노드에 상관없이 서비스에 지정된 포트번호만 사용하면 파드에 접근할 수 있다. 노드의 포트를 사용하므로, 클러스터 안 뿐만 아니라 클러스터 외부에서도 접근할 수 있다. 클러스터 외부에서 클러스터 안 파드로 접근할 때 사용할 수 있는 가장 간단한 방법이다.  

* **LoadBalancer** : 퍼블릭클라우드, 프라이빗클라우드, 그리고 쿠버네티스를 지원하는 로드밸런서 장비에서 사용한다. 클라우드에서 제공하는 로드밸런서와 파드를 연결한 후, 해당 로드밸런서의 IP를 이용해 클러스터 외부에서 파드에 접근할 수 있도록 한다. kubectl get service 명령으로 서비스 상태를 확인하면, EXTERNAL-IP 항목에 로드밸런서 IP를 표시한다. 이 IP를 사용해 클러스터 외부에서 파드에 접근할 수 있다.  

* **ExternalName** : 서비스를 .spec.externalName 필드에 설정한 값과 연결한다. 클러스터 안에서 외부에 접근할 때 주로 사용한다. 이 서비스로 클러스터 외부에 접근하면 설정해둔 CNAME값을 이용해 클러스터 외부에 접근할 수 있다. 클러스터 외부에 접근할 때 사용하는 값이므로 selector가 필요없다.  

## 서비스 사용하기
서비스 템플릿의 기본구조는 아래와 같다.  
~~~
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: ClusterIP            # 1
  clusterIP: 10.0.10.10      # 2
  selector:                  # 3
    app: MyApp
  ports:                     # 4
  - protocol: TCP
    port: 80
    targetPort: 9376
~~~

1. .spec.type 필드에서 서비스 타입을 설정할 수 있다. 설정하지 않으면 기본 타입은 ClusterIP이다.  

2. .spec.clusterIP필드에서 클러스터 IP를 직접 설정할 수 있다. 설정하지 않으면 자동으로 IP값이 할당된다.  

3. .spec.selector 필드에는 서비스와 연결할 파드에 설정한 .labels 필드 값을 설정한다.  

4. .spec.ports[] 필드는 배열 형태로, 서비스에서 한꺼번에 포트 여러개를 외부에 제공할 때 사용한다.  

  
  
우선 다음 명령으로 deployment로 생성하는 서비스에 연결할 파드를 실행한다. 
~~~
$ kubectl run nginx-for-service --image=nginx --replicas=2 --port=80 --labels="app=nginx-for-svc"
~~~
  

### ClusterIP 타입 서비스 이용하기
ClusterIP 타입의 서비스를 만드는 설정이다.  
~~~
apiVersion: v1
kind: Service
metadata:
  name: clusterip-service
spec:
  type: ClusterIP
  selector:
    app: nginx-for-svc
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
~~~















